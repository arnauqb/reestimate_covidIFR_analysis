---
title: "Reestimating the ESP IFR with Serology Data"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    highlight: textmate
    theme: lumen
    toc: yes
    toc_float: yes
    toc_depth: 3
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

# Spain

Population demographics and serological differences incorporate. Serology from household survey.
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      message = FALSE, eval = TRUE, 
                      results = 'hide', fig.align = 'center')
knitr::opts_knit$set(root.dir = here::here())
```
```{r}
# remotes::install_github("mrc-ide/COVIDCurve", ref = "develop")
library(COVIDCurve)
library(tidyverse)
source("R/extra_plotting_functions.R")
```


## Results {.tabset}

### Age Estimates
```{r}
#...................... 
# read in data
#......................
modout <- readRDS("results/ModFits/ESP_age_GTI2.5_rung50_burn10000_smpl10000.RDS")
```

#### Log Plot
```{r, results='asis', fig.width=8, fig.height=3}
modout$mcmcout$output %>%
  dplyr::filter(rung == "rung1") %>%
  dplyr::filter(stage == "sampling") %>%
  dplyr::select(c("iteration", "loglikelihood", "logprior")) %>%
  tidyr::gather(., key = "like", value = "val", 2:3) %>%
  ggplot() +
  geom_line(aes(x = iteration, y = val, color = like), size = 0.1, alpha = 0.8) +
  facet_wrap(.~like, scales = "free_y") +
  theme_bw()

```

#### Quick MCMC Diagnostics
```{r}
quickout <- quick_mc_diagnostics(modout)
```
```{r, results='asis', fig.width=8, fig.height=8}
quickout
```


#### IFRs & Incidence Curve

```{r}
agekey <- modout$inputs$IFRmodel$IFRdictkey %>% 
  dplyr::rename(param = Strata)
#...................... 
# get ifrs 
#......................
ifrs <- COVIDCurve::get_cred_intervals(IFRmodel_inf = modout, whichrung = paste0("rung", 1),
                                       what = "IFRparams", by_chain = FALSE)
ifrs <- dplyr::left_join(agekey, ifrs, by = "param")

#...................... 
# get incidence curve
#......................
infxncurve <- COVIDCurve::draw_posterior_infxn_cubic_splines(IFRmodel_inf = modout,
                                                             dwnsmpl = 1e3,
                                                             by_chain = FALSE)
#...................... 
# make ifr and incidence plots
#......................
plot1 <- ggplot() +
  geom_pointrange(data = ifrs, aes(x = ageband, ymin = LCI, ymax = UCI, y = median), color = "#252525") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.90, hjust= 1, face = "bold")) +
  xlab("") + ylab("Median (95% CIs)")

plot2 <- infxncurve$plotObj

main_plotObj <- cowplot::plot_grid(plot1, plot2, ncol = 1, nrow = 2)

jpeg("figures/ESP_ifr_plot_age.jpg", width = 11, height = 8, units = "in", res = 500)
main_plotObj
graphics.off()

```

```{r, results='asis', fig.width=8, fig.height=6}
main_plotObj
```

```{r, results='asis', fig.width=8, fig.height=6}
ifrs %>% 
  dplyr::mutate_if(is.numeric, round, 2) %>% 
  knitr::kable(.)

```

#### Seroprevalence Observerd vs. Inferred True Prev
```{r}
seropnts <- COVIDCurve::draw_posterior_inferred_seroprevalences(IFRmodel_inf = modout,
                                                                  dwnsmpl = 1e3,
                                                                  by_chain = FALSE)

seroprev_plotdat <- seropnts %>% 
  dplyr::select(., c("sim", dplyr::starts_with("seroprev_"))) %>% 
  tidyr::gather(., key = "param", value = "inf_seroprev", 2:ncol(.)) %>%
  dplyr::mutate(Strata = sub("seroprev_", "", param)) %>%
  dplyr::group_by(Strata) %>% 
  dplyr::summarise(
    min = min(inf_seroprev),
    LCI = quantile(inf_seroprev, 0.025),
    median = median(inf_seroprev),
    mean = mean(inf_seroprev),
    UCI = quantile(inf_seroprev, 0.975),
    max = max(inf_seroprev),
    ESS = coda::effectiveSize(coda::as.mcmc(inf_seroprev)),
    GewekeZ = coda::geweke.diag(coda::as.mcmc(inf_seroprev))[[1]],
    GewekeP = dnorm(GewekeZ)) %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$data$obs_serology, by = "Strata") %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$IFRdictkey, by = "Strata")

seroprev_plotdat <- seroprev_plotdat %>% 
  dplyr::arrange(ageband) %>% 
  dplyr::mutate(ageband = forcats::as_factor(ageband))

```

```{r, results='asis'}
ggplot() +
  geom_pointrange(data = seroprev_plotdat, aes(x = ageband, ymin = LCI, ymax = UCI, y = median), color = "#252525") +
  geom_point(data = seroprev_plotdat, aes(x = ageband, y = SeroPrev), color = "#3182bd") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.90, hjust= 1, face = "bold")) +
  xlab("") + ylab("Median (95% CIs)") +
  ggtitle("Observed vs. Inferred True Seroprevalence")


```


#### Seroprevalence Observerd vs. RG-Corrected Inferred Obs. Prev (Posterior Check)
```{r}
seropnts <- COVIDCurve::draw_posterior_RGobserved_seroprevalences(IFRmodel_inf = modout,
                                                                  dwnsmpl = 1e3,
                                                                  by_chain = FALSE)

seroprev_plotdat <- seropnts %>% 
  dplyr::select(., c("sim", dplyr::starts_with("seroprev_"))) %>% 
  tidyr::gather(., key = "param", value = "inf_seroprev", 2:ncol(.)) %>%
  dplyr::mutate(Strata = sub("seroprev_", "", param)) %>%
  dplyr::group_by(Strata) %>% 
  dplyr::summarise(
    min = min(inf_seroprev),
    LCI = quantile(inf_seroprev, 0.025),
    median = median(inf_seroprev),
    mean = mean(inf_seroprev),
    UCI = quantile(inf_seroprev, 0.975),
    max = max(inf_seroprev),
    ESS = coda::effectiveSize(coda::as.mcmc(inf_seroprev)),
    GewekeZ = coda::geweke.diag(coda::as.mcmc(inf_seroprev))[[1]],
    GewekeP = dnorm(GewekeZ)) %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$data$obs_serology, by = "Strata") %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$IFRdictkey, by = "Strata")

seroprev_plotdat <- seroprev_plotdat %>% 
  dplyr::arrange(ageband) %>% 
  dplyr::mutate(ageband = forcats::as_factor(ageband))

```

```{r, results='asis'}
ggplot() +
  geom_pointrange(data = seroprev_plotdat, aes(x = ageband, ymin = LCI, ymax = UCI, y = median), color = "#252525") +
  geom_point(data = seroprev_plotdat, aes(x = ageband, y = SeroPrev), color = "#3182bd") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.90, hjust= 1, face = "bold")) +
  xlab("") + ylab("Median (95% CIs)") +
  ggtitle("Observed vs. RG-Corrected Inferred Observed Seroprevalence (Posterior Check)")


```


#### Posterior Predictive Check
```{r}
#...................... 
# get posterior draws
#......................
postdat <- COVIDCurve::posterior_check_infxns_to_death(IFRmodel_inf = modout,
                                                       dwnsmpl = 1e3,
                                                       by_chain = FALSE)
postdat_long <- postdat %>%
  dplyr::select(c("sim", "time", dplyr::starts_with("deaths"))) %>%
  tidyr::gather(., key = "param", value = "deaths", 3:ncol(.)) %>%
  dplyr::mutate(param = gsub("deaths_", "", param)) %>% 
  dplyr::left_join(., y = agekey, by = "param") 

#......................
# get deaths posterior pred check
#......................
datclean <-  modout$inputs$IFRmodel$data$obs_deaths %>%
  dplyr::filter(Deaths != -1) %>% 
  dplyr::left_join(., modout$inputs$IFRmodel$IFRdictkey, by = "Strata")



#...................... 
# make plot
#......................
ppc_plot_age <- ggplot() +
  geom_line(data = postdat_long, aes(x= time, y = deaths, group = ageband), 
            size = 1.2, color = "#bdbdbd") +
  geom_line(data = datclean, aes(x=ObsDay, y = Deaths, group = ageband), 
            color = "#3182bd") +
  facet_wrap(.~ageband) +
  theme_bw() +
  ggtitle("Posterior Predictive Check", subtitle = "Grey Lines are Draws from Posterior, Blue Line is Observed Data (from ECDC)") +
  theme(plot.title = element_text(hjust = 0.5, vjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, vjust = 0.5))

jpeg("figures/ESP_ppc_plot_age.jpg", width = 11, height = 8, units = "in", res = 500)
ppc_plot_age
graphics.off()

```

```{r, results='asis'}
ppc_plot_age
```

### Regional Estimates
```{r}
#...................... 
# read in data
#......................
modout <- readRDS("results/ModFits/ESP_rgns_GTI3_rung25_burn10000_smpl10000.RDS")$fit
rgnkey <- agekey <- modout$inputs$IFRmodel$IFRdictkey %>% 
  dplyr::rename(param = Strata)
```

#### Log Plot
```{r, results='asis', fig.width=8, fig.height=3}
modout$mcmcout$output %>%
  dplyr::filter(rung == "rung1") %>%
  dplyr::filter(stage == "sampling") %>%
  dplyr::select(c("iteration", "loglikelihood", "logprior")) %>%
  tidyr::gather(., key = "like", value = "val", 2:3) %>%
  ggplot() +
  geom_line(aes(x = iteration, y = val, color = like), size = 0.1, alpha = 0.8) +
  facet_wrap(.~like, scales = "free_y") +
  theme_bw()

```

#### Quick MCMC Diagnostics
```{r, results='asis', fig.width=8, fig.height=8}
quick_mc_diagnostics(modout)
```


#### IFRs & Incidence Curve

```{r}
#...................... 
# get ifrs 
#......................
ifrs <- COVIDCurve::get_cred_intervals(IFRmodel_inf = modout, whichrung = paste0("rung", 1),
                                       what = "IFRparams", by_chain = FALSE)
ifrs <- dplyr::left_join(rgnkey, ifrs, by = "param")

#...................... 
# get incidence curve
#......................
infxncurve <- COVIDCurve::draw_posterior_infxn_cubic_splines(IFRmodel_inf = modout,
                                                             dwnsmpl = 1e3,
                                                             by_chain = FALSE)
#...................... 
# make ifr and incidence plots
#......................
plot1 <- ggplot() +
  geom_pointrange(data = ifrs, aes(x = region, ymin = LCI, ymax = UCI, y = median), color = "#252525") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.90, hjust= 1, face = "bold")) +
  xlab("") + ylab("Median (95% CIs)")

plot2 <- infxncurve$plotObj

main_plotObj <- cowplot::plot_grid(plot1, plot2, ncol = 1, nrow = 2)

jpeg("figures/ESP_ifr_plot_rgn.jpg", width = 11, height = 8, units = "in", res = 500)
main_plotObj
graphics.off()

```

```{r, results='asis', fig.width=8, fig.height=6}
main_plotObj
```

```{r, results='asis', fig.width=8, fig.height=6}
ifrs %>% 
  dplyr::mutate_if(is.numeric, round, 2) %>% 
  knitr::kable(.)

```

#### Seroprevalence Observerd vs. Inferred True Prev
```{r}
seropnts <- COVIDCurve::draw_posterior_inferred_seroprevalences(IFRmodel_inf = modout,
                                                                  dwnsmpl = 1e3,
                                                                  by_chain = FALSE)

seroprev_plotdat <- seropnts %>% 
  dplyr::select(., c("sim", dplyr::starts_with("seroprev_"))) %>% 
  tidyr::gather(., key = "param", value = "inf_seroprev", 2:ncol(.)) %>%
  dplyr::mutate(Strata = sub("seroprev_", "", param)) %>%
  dplyr::group_by(Strata) %>% 
  dplyr::summarise(
    min = min(inf_seroprev),
    LCI = quantile(inf_seroprev, 0.025),
    median = median(inf_seroprev),
    mean = mean(inf_seroprev),
    UCI = quantile(inf_seroprev, 0.975),
    max = max(inf_seroprev),
    ESS = coda::effectiveSize(coda::as.mcmc(inf_seroprev)),
    GewekeZ = coda::geweke.diag(coda::as.mcmc(inf_seroprev))[[1]],
    GewekeP = dnorm(GewekeZ)) %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$data$obs_serology, by = "Strata") %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$IFRdictkey, by = "Strata")

seroprev_plotdat <- seroprev_plotdat %>% 
  dplyr::arrange(region) %>% 
  dplyr::mutate(region = forcats::as_factor(region))

```

```{r, results='asis'}
ggplot() +
  geom_pointrange(data = seroprev_plotdat, aes(x = region, ymin = LCI, ymax = UCI, y = median), color = "#252525") +
  geom_point(data = seroprev_plotdat, aes(x = region, y = SeroPrev), color = "#3182bd") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.90, hjust= 1, face = "bold")) +
  xlab("") + ylab("Median (95% CIs)") +
  ggtitle("Observed vs. Inferred True Seroprevalence")


```


#### Seroprevalence Observerd vs. RG-Corrected Inferred Obs. Prev (Posterior Check)
```{r}
seropnts <- COVIDCurve::draw_posterior_RGobserved_seroprevalences(IFRmodel_inf = modout,
                                                                  dwnsmpl = 1e3,
                                                                  by_chain = FALSE)

seroprev_plotdat <- seropnts %>% 
  dplyr::select(., c("sim", dplyr::starts_with("seroprev_"))) %>% 
  tidyr::gather(., key = "param", value = "inf_seroprev", 2:ncol(.)) %>%
  dplyr::mutate(Strata = sub("seroprev_", "", param)) %>%
  dplyr::group_by(Strata) %>% 
  dplyr::summarise(
    min = min(inf_seroprev),
    LCI = quantile(inf_seroprev, 0.025),
    median = median(inf_seroprev),
    mean = mean(inf_seroprev),
    UCI = quantile(inf_seroprev, 0.975),
    max = max(inf_seroprev),
    ESS = coda::effectiveSize(coda::as.mcmc(inf_seroprev)),
    GewekeZ = coda::geweke.diag(coda::as.mcmc(inf_seroprev))[[1]],
    GewekeP = dnorm(GewekeZ)) %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$data$obs_serology, by = "Strata") %>% 
  dplyr::left_join(., y = modout$inputs$IFRmodel$IFRdictkey, by = "Strata")

seroprev_plotdat <- seroprev_plotdat %>% 
  dplyr::arrange(region) %>% 
  dplyr::mutate(region = forcats::as_factor(region))

```

```{r, results='asis'}
ggplot() +
  geom_pointrange(data = seroprev_plotdat, aes(x = region, ymin = LCI, ymax = UCI, y = median), color = "#252525") +
  geom_point(data = seroprev_plotdat, aes(x = region, y = SeroPrev), color = "#3182bd") + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.90, hjust= 1, face = "bold")) +
  xlab("") + ylab("Median (95% CIs)") +
  ggtitle("Observed vs. RG-Corrected Inferred Observed Seroprevalence (Posterior Check)")


```

#### Posterior Predictive Check
```{r}
#...................... 
# get posterior draws
#......................
postdat <- COVIDCurve::posterior_check_infxns_to_death(IFRmodel_inf = modout,
                                                       dwnsmpl = 1e3,
                                                       by_chain = FALSE)
postdat_long <- postdat %>%
  dplyr::select(c("sim", "time", dplyr::starts_with("deaths"))) %>%
  tidyr::gather(., key = "param", value = "deaths", 3:ncol(.)) %>%
  dplyr::mutate(param = gsub("deaths_", "", param)) %>% 
  dplyr::left_join(., y = rgnkey, by = "param")

#......................
# get deaths posterior pred check
#......................
datclean <-  modout$inputs$IFRmodel$data$obs_deaths %>%
  dplyr::filter(Deaths != -1)  %>% 
  dplyr::left_join(., modout$inputs$IFRmodel$IFRdictkey, by = "Strata")

#...................... 
# make plot
#......................
ppc_plot_rgn <- ggplot() +
  geom_line(data = postdat_long, aes(x= time, y = deaths, group = region), 
            size = 1.2, color = "#bdbdbd") +
  geom_line(data = datclean, aes(x=ObsDay, y = Deaths, group = region), 
            color = "#3182bd") +
  facet_wrap(.~region) +
  theme_bw() +
  ggtitle("Posterior Predictive Check", subtitle = "Grey Lines are Draws from Posterior, Blue Line is Observed Data (from ECDC)") +
  theme(plot.title = element_text(hjust = 0.5, vjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, vjust = 0.5))


jpeg("figures/ESP_ppc_plot_rgn.jpg", width = 11, height = 8, units = "in", res = 500)
ppc_plot_rgn
graphics.off()

```


```{r, results='asis', fig.width=8, fig.height=6}
ppc_plot_rgn
```


## {-}
